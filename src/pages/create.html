<!DOCTYPE html>
<html lang="en">
  <head>
    <title>AR Postcard</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.2.0/socket.io.js"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/create.css">
    <script type="text/javascript" src="js/landmarks.js"></script>
    <script type="text/javascript" src="js/script.js"></script>
  </head>
  
  <body>
    <h1>Create Your Postcard</h1>
    <div class="landmark-wrapper">
        <label for="select-landmark">Landmark:</label>
        <div class="input-wrapper">
          <input
          id="img-input"
          type="file"
          accept="image/*; capture=camera"
          onchange= "handleImageChange(this)"
          />
          <select id="select-landmark" name="select-landmark"></select>
        </div>
        
        <img id="img-output" crossorigin="anonymous" />
      
        <a-scene background="color: #FAFAFA" embedded>
          <a-sky id="preview-sky"
                 src ="images/france.jpg">
          </a-sky>
          <a-entity id="preview-gltf" 
                    position="0 0 -6" 
                    gltf-model="images/eiffel.glb"
                    scale = "0.15 0.15 0.15">
          </a-entity>
          <a-text id="preview-txt"
                  font="https://cdn.aframe.io/fonts/mozillavr.fnt"
                  value="" 
                  scale="2 2 1" 
                  color="white"
                  position="-5 -2 -6"
                  width="5"
                  wrap-count="30">
          </a-text>
        </a-scene> 
    </div>
    
    <div class="message-wrapper">
        <label for="message">Your Message:</label>
        <textarea id="input-message" name="message" rows="5" cols="50" placeholder="message..."></textarea>
    </div>

    <div class="button-wrapper">
        <button class="button-56 secondaryBtn" role="button" id="backBtn">
          Back
        </button>
        <button class="button-56 primaryBtn" role="button" id="createBtn">
          Create
        </button>
    </div>
  </body>
  
  <script>
    Object.keys(Landmarks).forEach(landmark => {
      // console.log(landmark)
      $("#select-landmark").append(`<option value="${landmark}">${landmark.charAt(0).toUpperCase() + landmark.slice(1)}</option>`)
    })
    
    $("#select-landmark").change(function(e) {
      $('#img-output').attr('src', "");
      var selected = $("#select-landmark :selected").val();
      var res = Landmarks[selected]["baseUrl"];
      var scale = Landmarks[selected]["previewScale"];
      var sky = Landmarks[selected]["backgroundUrl"];
      $("#preview-gltf").attr("gltf-model", res);
      $("#preview-gltf").attr("scale", scale);
      $('#preview-sky').attr("src", sky);
    });
    
    var textArea = document.getElementById("input-message");
    var aText = document.getElementById("preview-txt");
    textArea.addEventListener('input', () => {
      text = textArea.value;
      aText.setAttribute('value', text);
    });
    
    var socket = io();
    socket.connect("https://ar-postcards.glitch.me/:3000");
    var address = window.location.href;
    var root = address.substring(0, address.lastIndexOf("/") + 1);
    var who = address.substring(address.lastIndexOf("=") + 1);
    
    $(document).ready(() => {
      $("#backBtn").click(function() {
        var back = root;
        window.location.href = back;
      });
    });
    
    $(document).ready(() => {
      $("#createBtn").click(function() {
        console.log("creating postcard");

        // assign user selected data here for setup
        var userName = who;
        var landmark = $("#select-landmark").val();
        var message = $("#input-message").val();
        
        if (userName) {
          var newPostcard = {
            username: userName,
            landmark: landmark,
            message: message,
            timestamp: Date.now()
          }

          socket.emit("new-postcard", newPostcard);
          
          // redirect to address with query parameters room for socket
          var join = root + "lobby" + `?name=${userName}`;
          window.location.href = join;
        }
      });
    });
  </script>
</html>
