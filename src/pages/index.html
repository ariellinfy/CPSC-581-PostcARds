<!DOCTYPE html>
<html lang="en">
  <head>
    <title>AR Postcard</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.2.0/socket.io.js"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/index.css">
    <script type="text/javascript" src="js/landmarks.js"></script>
  </head>
  <body>
    <h1>Postcard Collections</h1>
    <div id="collections" class="album-wrapper">
<!--         <div class="postcard">
          <a-scene background="color: #FFFFFF" embedded>
            <a-entity class="preview-gltf" position="0 0 -6" scale = "0.15 0.15 0.15" gltf-model="https://cdn.glitch.global/e76c002c-c9da-46f1-9730-df8080677b3f/eiffel.glb?v=1702601607283"></a-entity>
            <a-text value="The Eiffel Tower is as magnificent as they say - breathtaking views that make me feel like I'm on top of the world! --- from Sarah" 
                    scale="2 2 1" 
                    color="black"
                    position="-5 -2 -6"
                    width="5"
                    wrap-count="30">
            </a-text>
          </a-scene>
          <div>
            The Eiffel Tower is as magnificent as they say - breathtaking views that make me feel like I'm on top of the world! --- from Sarah
          </div>
        </div>
        <div class="postcard">
          <a-scene background="color: #FFFFFF" embedded>
            <a-entity class="preview-gltf" position="0 0 -6" scale = "0.15 0.15 0.15" gltf-model="https://cdn.glitch.global/e76c002c-c9da-46f1-9730-df8080677b3f/eiffel.glb?v=1702601607283"></a-entity>
            <a-text value="The Eiffel Tower is as magnificent as they say - breathtaking views that make me feel like I'm on top of the world! --- from Sarah" 
                    scale="2 2 1" 
                    color="black"
                    position="-5 -2 -6"
                    width="5"
                    wrap-count="30">
            </a-text>
          </a-scene>
          <div>
            The Eiffel Tower is as magnificent as they say - breathtaking views that make me feel like I'm on top of the world! --- from Sarah
          </div>
        </div> -->
    </div>
  </body>
  <script>
      var socket = io();
      socket.connect("https://ar-postcards.glitch.me/:3000");
    
      var address = window.location.href;
      var isQuery = address.lastIndexOf("=");
      var who = "";
      if (isQuery !== -1){
        who = address.substring(isQuery + 1);
      }

      if (who) {
        socket.emit("new-user", who);
      }
    
      socket.on("user-joined", postcards => {
        console.log(postcards);
        $('#collections').empty();
        postcards.forEach((postcard, i) => {
          addPostcard(postcard);
        })
      });
    
      function addPostcard(postcard) {
        
        var baseSrc = Landmarks[postcard.landmark]["baseUrl"];
        var backgroundUrl = Landmarks[postcard.landmark]["backgroundUrl"];
        
        var cardBlock = $(`<div class="postcard"></div>`);
        var landmarkScene = $(`<a-scene background="color: #FFFFFF" embedded></a-scene>`);
        var landmarkAssets = `<a-assets><img id="${postcard.landmark}" src=${backgroundUrl}></a-assets>`;
        var landmarkSky = `<a-sky src="#${postcard.landmark}"></a-sky>`;
        var userText = $(`<a-text class="text-bold" value="from ${postcard.username}:" scale="1.5 1.5 1" color="gray" position="-5 3 -6" width="5"></a-text>`);
        var landmarkEntity = $(`<a-entity class="preview-gltf" rotation="0 0 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 10000" position="0 0 -6" scale = "0.15 0.15 0.15" gltf-model=${baseSrc}></a-entity>`);
        var landmarkText = $(`<a-text value="${postcard.message}" scale="2 2 1" color="black" position="-5 -1.5 -6" width="5"></a-text>`);
        
        landmarkScene.append(landmarkAssets);
        landmarkScene.append(userText);
        landmarkScene.append(landmarkSky);
        landmarkScene.append(landmarkEntity);
        landmarkScene.append(landmarkText);
        
        cardBlock.append(landmarkScene);
        
        $('#collections').append(cardBlock);
      }
  </script>
</html>
